---
title: 'NHANES 2017/2018 Study 2'
author: 
  - Theophilus Baidoo^[tbaidoo@iu.edu, Indiana University Bloomington (IUB).]
date: "`r format(Sys.Date(), '%B %d, %Y')`"
output:
  bookdown::pdf_document2:
    fig_caption: true
    latex_engine: xelatex
    number_sections: true
    toc: true
    toc_depth: 4
header-includes:
  - \usepackage{amsmath}
  - \usepackage{amssymb}
  - \usepackage{amsfonts}
  - \usepackage{amsthm}
  - \usepackage{floatrow}
  - \usepackage{fancyhdr}
  - \pagestyle{fancy}
  - \fancyhf{}
  - \rhead{Theophilus Baidoo}
  - \lhead{Project `r params$proj_number` -- `r params$proj_title`}
  - \cfoot{\thepage}
  - \usepackage{algorithm}
  - \usepackage[noend]{algpseudocode}
geometry: margin = 0.8in
fontsize: 10pt
params:
  proj_number: I
  proj_title: NHANES Study 2
---


```{r, message=FALSE, warning=FALSE}

library(tidyverse)
library(naniar)
library(VIM)
library(DataExplorer)
library(mice)
library(DMwR2)
library(dplyr)
library(ggplot2)
library(gtsummary)
library(gt)
library(mitools)
library(survey)
library(cobalt)
library(MatchIt)
library(tableone)
library(geepack)
library(epiR)
library(tidyverse)
library(fs)
library(tableone)
library(table1)
library(flextable)
library(tableone)
library(dplyr)
library(flextable)
library(officer)
library(tibble)
library(MatchIt)
library(broom)
library(flextable)
library(cobalt)
library(ggplot2)
library(jtools)
library(nnet)


set.seed(100)
```


```{r}

data_nhanes <- readRDS("nhanes_cleandata2.rds")
dim(data_nhanes)
names(data_nhanes)
```


```{r}
data_nhanes <- data_nhanes %>%
  dplyr::rename(Exposure = trouble_sleep) 


data_nhanes <- data_nhanes %>%
  mutate(
    marital_status = case_when(
      marital_status %in% c("Never married", "Divorced", "Living with partner", "Widowed", "Separated") ~ "Not Married",
      marital_status == "Married" ~ "Married",
      marital_status == "Refused" ~ NA_character_,
      TRUE ~ as.character(marital_status)  # preserves existing NA
    ),
    marital_status = factor(marital_status, levels = c("Married", "Not Married"))
  )

data_nhanes <- data_nhanes %>%
  mutate(
    current_smoker = case_when(
      current_smoker %in% c("Every day", "Some days") ~ "Smoker",
      current_smoker == "Not at all" ~ "Non-Smoker",
      TRUE ~ as.character(current_smoker)  # preserves NA
    ),
    current_smoker = factor(current_smoker, levels = c("Smoker", "Non-Smoker"))
  )

data_nhanes <- data_nhanes %>%
  mutate(
    race_ethnicity = case_when(
      race_ethnicity %in% c("Mexican American", "Other Hispanic") ~ "Hispanic",
      race_ethnicity == "Non-Hispanic Black" ~ "Non-Hispanic Black",
      race_ethnicity == "Non-Hispanic White" ~ "Non-Hispanic White",
      race_ethnicity == "Other Race - Including Multi-Racial" ~ "Other",
      TRUE ~ as.character(race_ethnicity)  # preserves NA
    ),
    race_ethnicity = factor(race_ethnicity, levels = c("Non-Hispanic White", "Non-Hispanic Black", "Hispanic", "Other"))
  )

data_nhanes <- data_nhanes %>%
  mutate(
    diabetes = case_when(
      diabetes == "Yes" ~ "Diabetic",
      diabetes %in% c("No", "Borderline") ~ "Not Diabetic",
      TRUE ~ as.character(diabetes)  # preserves NA
    ),
    diabetes = factor(diabetes, levels = c("Diabetic", "Not Diabetic"))
  )


data_nhanes <- data_nhanes %>%
  mutate(
    Obesity = case_when(
      is.na(bmi) ~ NA_character_,  # Preserve missing values
      bmi >= 30 ~ "Obese",
      bmi < 30 ~ "Not Obese"
    ),
    Obesity = factor(Obesity, levels = c("Not Obese", "Obese"))  # Convert to factor
  )


data_nhanes <- data_nhanes %>%
  mutate(
    Age_Group = cut(age, 
      breaks = quantile(age, probs = c(0, 1/3, 2/3, 1), na.rm = TRUE), 
      include.lowest = TRUE, 
      labels = c("18-39", "40-61", "62+"))
  )

data_nhanes <- data_nhanes %>%
  mutate(
    # HDL: Low if <40 (men) or <50 (women)
    hdl = case_when(
      gender == "Male" & hdl < 40 ~ "Low",
      gender == "Female" & hdl < 50 ~ "Low",
      !is.na(hdl) ~ "Normal",
      TRUE ~ NA_character_
    ),
    hdl = factor(hdl, levels = c("Normal", "Low")),

    # LDL: High if >= 130 mg/dL
    ldl = case_when(
      ldl >= 130 ~ "High",
      !is.na(ldl) ~ "Normal",
      TRUE ~ NA_character_
    ),
    ldl = factor(ldl, levels = c("Normal", "High")),

    # Triglycerides: Cap at 1000, then classify
    triglycerides = ifelse(triglycerides > 1000, 1000, triglycerides),
    triglycerides = case_when(
      triglycerides >= 150 ~ "Elevated",
      !is.na(triglycerides) ~ "Normal",
      TRUE ~ NA_character_
    ),
    triglycerides = factor(triglycerides, levels = c("Normal", "Elevated"))
  )


data_nhanes$alcohol_cat <- cut(
  data_nhanes$alcohol_day,
  breaks = c(0, 2, Inf),
  labels = c("1–2/day", "3+/day"),
  right = TRUE
)


data_nhanes <- data_nhanes %>%
  mutate(
    education = case_when(
      education %in% c("Less than 9th grade", 
                       "9-11th grade (Includes 12th grade with no diploma)") ~ "Less than high school",
      education == "High school graduate/GED or equivalent" ~ "High school/GED",
      education == "Some college or AA degree" ~ "Some college",
      education == "College graduate or above" ~ "College graduate",
      TRUE ~ NA_character_  # Keep missing as NA
    ),
    education = factor(education, levels = c(
      "Less than high school", 
      "High school/GED", 
      "Some college", 
      "College graduate"
    ))
  )
data_nhanes <- data_nhanes %>%
  mutate(
    apnea_symptoms = case_when(
      apnea_symptoms == "Never" ~ "No reported apnea symptoms",
      apnea_symptoms %in% c(
        "Rarely - 1-2 nights a week",
        "Occasionally - 3-4 nights a week",
        "Frequently - 5 or more nights a week"
      ) ~ "Reported apnea symptoms",
      TRUE ~ NA_character_
    ),
    apnea_symptoms = factor(
      apnea_symptoms,
      levels = c("No reported apnea symptoms", "Reported apnea symptoms")
    )
  )


data_nhanes <- data_nhanes %>%
  mutate(
    daytime_sleepy = case_when(
      daytime_sleepy == "Never" ~ "Never",
      daytime_sleepy %in% c(
        "Rarely - 1 time a month",
        "Sometimes - 2-4 times a month",
        "Often- 5-15 times a month"
      ) ~ "Occasional",
      daytime_sleepy == "Almost always - 16-30 times a month" ~ "Frequent",
      TRUE ~ NA_character_  # Keep missing as NA
    ),
    daytime_sleepy = factor(daytime_sleepy, levels = c("Never", "Occasional", "Frequent"))
  )
data_nhanes <- data_nhanes %>%
  mutate(
    depression = case_when(
      depression == "Not at all" ~ "None",
      depression == "Several days" ~ "Mild",
      depression %in% c("More than half the days", "Nearly every day") ~ "Moderate/Severe",
      TRUE ~ NA_character_
    ),
    depression = factor(depression, levels = c("None", "Mild", "Moderate/Severe"))
  )
data_nhanes <- data_nhanes %>%
  mutate(
    work_schedule = case_when(
      work_schedule == "Traditional 9 AM to 5 PM day" ~ "Daytime job",
      work_schedule %in% c(
        "Early mornings",
        "Evening or nights",
        "Variable (early mornings, days, and nights)"
      ) ~ "Non-daytime job",
      TRUE ~ NA_character_
    ),
    work_schedule= factor(work_schedule, levels = c("Daytime job", "Non-daytime job"))
  )


data_nhanes <- data_nhanes %>%
  mutate(
    snore = case_when(
      snore == "Frequently - 5 or more nights a week" ~ "Frequent",
      snore %in% c("Occasionally - 3-4 nights a week", "Rarely - 1-2 nights a week") ~ "Occasional",
      snore == "Never" ~ "Never",
      TRUE ~ NA_character_
    ),
    snore = factor(snore, levels = c("Never", "Occasional", "Frequent"))
  )

```


```{r}
data_nhanes$dyslipidemia <- with(data_nhanes, 
  ifelse(ldl == "High" | hdl == "Low" | triglycerides == "Elevated", "Yes",
         ifelse(!is.na(ldl) & !is.na(hdl) & !is.na(triglycerides), "No", NA))
)

data_nhanes$dyslipidemia <- factor(data_nhanes$dyslipidemia, levels = c("No", "Yes"))


data_nhanes$physically_active <- with(data_nhanes, ifelse(
  work_vigorous == "Yes" |
  work_moderate == "Yes" |
  walk_bike == "Yes" |
  leisure_vigorous == "Yes" |
  leisure_moderate == "Yes",
  "Yes",
  ifelse(
    !is.na(work_vigorous) & !is.na(work_moderate) &
    !is.na(walk_bike) & !is.na(leisure_vigorous) & !is.na(leisure_moderate),
    "No", NA)
))

data_nhanes$physically_active <- factor(data_nhanes$physically_active, levels = c("No", "Yes"))


```



```{r}
data_nhanes <- data_nhanes %>% dplyr::select(
   -alcohol_day, -age, -ldl, -hdl, -triglycerides,
  -work_vigorous, -work_moderate, -walk_bike, -leisure_vigorous, -leisure_moderate
)

```




```{r}
n_total <- nrow(data_nhanes)


model1_vars <- c("Obesity","snore", "Age_Group", "gender", "race_ethnicity", "income_ratio", "education")
n_model1 <- sum(complete.cases(data_nhanes[, model1_vars]))


model2_vars <- c(model1_vars, "physically_active", "sat_fat", "sugar", "alcohol_cat", 
                 "dyslipidemia", "hypertension", "depression", "diabetes")
n_model2 <- sum(complete.cases(data_nhanes[, model2_vars]))


model3_vars <- c(model2_vars, "apnea_symptoms", "sleep_weekday", "daytime_sleepy", "sleep_weekend","work_schedule")
n_model3 <- sum(complete.cases(data_nhanes[, model3_vars]))


cat("Total participants:", n_total, "\n")
cat("Complete cases for Model 1:", n_model1, "\n")
cat("Complete cases for Model 2:", n_model2, "\n")
cat("Complete cases for Model 3:", n_model3, "\n")

```


# Complete Case Analysis for Model 1

```{r}
# All variables across all models
vars_all_models <- c(
  "Obesity", "daytime_sleepy",            # Outcome & exposure
  "Age_Group", "gender", "race_ethnicity", "income_ratio", "education", "work_schedule",  # Model 1
  "physically_active", "sat_fat", "sugar","energy_kcal", "alcohol_cat", 
  "dyslipidemia", "hypertension", "depression", "diabetes",                        # Model 2
  "apnea_symptoms","snore", "sleep_weekday", "sleep_weekend"  # Model 3
)

# Complete-case data for all models
complete_cases_all_models2 <- data_nhanes %>%
  drop_na(all_of(vars_all_models))


#saveRDS(complete_cases_all_models2, "results/complete_case_all_models2.rds")

```




```{r, include=FALSE}
analysis_vars <- c(
  "SEQN","Obesity", "daytime_sleepy",            # Outcome & exposure
  "Age_Group", "gender", "race_ethnicity", "income_ratio", "education", "work_schedule","psu", "stratum","interview_weight",  # Model 1
   "physically_active", "energy_kcal", "sat_fat", "sugar", "alcohol_cat", 
  "dyslipidemia", "hypertension", "depression", "diabetes",                        # Model 2
  "apnea_symptoms","snore", "sleep_weekday", "sleep_weekend"  # Model 3
)

analysis_datasnore <- complete_cases_all_models2 %>%
  dplyr::select(all_of(analysis_vars))



```



```{r}
# Drop design variables from the display set
vars_display <- setdiff(colnames(analysis_datasnore), c("SEQN","psu", "stratum", "interview_weight"))

# Create table using only the selected variables
table_data <- analysis_datasnore %>%
  dplyr::select(all_of(vars_display))

# Create Table 1
sum_table <- table1(~ . | snore, data = table_data)

sum_table



```





## Analyzing Complete Case dataset for Snore Exposure


# Building model 1

```{r}
covars <- intersect(colnames(analysis_datasnore), c("Age_Group", "education", "gender", "race_ethnicity", "income_ratio"))
exposure <- "snore"
```



```{r}
#–– 0. Load all the libraries you need ––#
library(nnet)         # multinom()
library(survey)       # svydesign(), svyglm()
library(ggpubr)       # ggdensity()
library(tableone)     # svyCreateTableOne()
library(cobalt)       # love.plot()
```

```{r}
# Table 1

tab1 <- CreateTableOne(vars = covars, strata = "snore", data = analysis_datasnore, test = F)
print(tab1, smd = T, showAllLevels = T)
```


```{r}


#–– 3. Fit a multinomial PS model (with NHANES interview weights) ––#
ps_formula <- as.formula(paste(exposure, "~", paste(covars, collapse = " + ")))

ps_fit <- multinom(ps_formula,
                   data    = analysis_datasnore,
                   weights = analysis_datasnore$interview_weight,
                   trace   = FALSE)
```

```{r}
#–– 4. Get fitted probabilities for each level ––#
ps_mat <- predict(ps_fit, type = "probs")
analysis_datasnore$p_Never      <- ps_mat[, "Never"]
analysis_datasnore$p_Occasional <- ps_mat[, "Occasional"]
analysis_datasnore$p_Frequent   <- ps_mat[, "Frequent"]
```

```{r}
#–– 5. Compute stabilized weights ––#
#  5a. Marginal (unadjusted) probabilities of each snore level
marg_never      <- mean(analysis_datasnore$snore == "Never")
marg_occasional <- mean(analysis_datasnore$snore == "Occasional")
marg_frequent   <- mean(analysis_datasnore$snore == "Frequent")
```



```{r}
#5b. Individual stabilized weight = P(A=a) / p_i(a | X)
analysis_datasnore$sweight_raw <- with(analysis_datasnore,
  ifelse(snore == "Never",      marg_never  / p_Never,
  ifelse(snore == "Occasional", marg_occasional / p_Occasional,
                                        marg_frequent   / p_Frequent))
)
```


```{r}
#  5c. Truncate at the 1st and 99th percentiles
q01 <- quantile(analysis_datasnore$sweight_raw, 0.01)
q99 <- quantile(analysis_datasnore$sweight_raw, 0.99)
analysis_datasnore$sweight_trim <- pmin(pmax(analysis_datasnore$sweight_raw, q01), q99)
```

```{r}
with(analysis_datasnore, by(sweight_trim, snore, summary))

```
```{r}
summary(analysis_datasnore$sweight_trim)
```


```{r}
#–– 6. Plot the PS distributions by actual snore level ––#
#    (using the PS of the received treatment)
analysis_datasnore$ps_assigned <- with(analysis_datasnore,
  ifelse(snore == "Never",      p_Never,
  ifelse(snore == "Occasional", p_Occasional, p_Frequent))
)
ps_plot <- ggdensity(
  analysis_datasnore,
  x      = "ps_assigned",
  fill   = "snore",
  palette= c("#66c2a5", "#fc8d62", "#8da0cb")
) +
  labs(
    x    = "Propensity Score for Observed Snore Level",
    fill = "Snore"
  ) +
  theme_classic() +
  theme(
    legend.position        = c(.85, .85),
    legend.background      = element_rect(color="grey", fill="white"),
    axis.title             = element_text(size=14),
    axis.text              = element_text(size=12),
    legend.title           = element_text(size=12),
    legend.text            = element_text(size=11)
  )
ps_plot
```



```{r}
library(tableone)


cov2 <- c("gender", "race_ethnicity", "education", "income_ratio",
         "Age_Group")

design.stab <- svydesign(ids = ~SEQN, weights = ~sweight_trim, data = analysis_datasnore)


# Create table ensuring proper data type handling
tab.stab2 <- svyCreateTableOne(
  vars = cov2,
  strata = "snore",
  data = design.stab,
  test = FALSE
)


print(tab.stab2, smd = TRUE)
```

```{r}
bal <- bal.tab(snore ~ gender + race_ethnicity + education + income_ratio + Age_Group,
               data = analysis_datasnore,
               weights = analysis_datasnore$sweight_trim,
               method = "weighting",
               s.d.denom = "pooled",
               un = TRUE)

```

```{r}
bal$Balance


```



```{r}
p <- love.plot(bal,
               weights = analysis_datasnore$sweight_trim,
               data = analysis_datasnore,
               method = "weighting",
               thresholds = c(m = 0.2),
               abs = FALSE,
               shapes = c("circle filled", "triangle filled"),
               colors = c("orange", "green"),
               e.names = c("Original", "Weighted (IPW)"),
               size = 7,
               binary = "std",
               continuous = "std",
               s.d.denom = "pooled",
               var.names = label)
p
```
Note: The table reports the maximum absolute SMD per covariate level (e.g., gender_Male). The love plot displays the maximum across all pairwise group comparisons for each dummy variable.


```{r}
#–– 9. Create the NHANES survey design with final weights ––#
analysis_datasnore$final_wt <- analysis_datasnore$interview_weight * analysis_datasnore$sweight_trim

nhanes_design <- svydesign(
  id      = ~psu,
  strata  = ~stratum,
  weights = ~final_wt,
  data    = analysis_datasnore,
  nest    = TRUE
)
```


```{r}
#––10. Fit Modified Poisson to estimate Prevalence Ratios ––#
mpr_formula <- as.formula(
  "I(Obesity == 'Obese') ~ snore +
     gender + race_ethnicity + education + income_ratio + Age_Group"
)
mpr_model <- svyglm(
  mpr_formula,
  design = nhanes_design,
  family = poisson(link = "log")
)

#––11. Extract PRs and 95% CIs ––#
PR  <- exp(coef(mpr_model))
CI  <- exp(confint(mpr_model))
res <- data.frame(
  Term       = names(PR),
  PR         = round(PR, 3),
  CI_lower   = round(CI[,1], 3),
  CI_upper   = round(CI[,2], 3)
)
print(res)
```






## Bilding model 2

```{r}
analysis_vars <- c(
  "SEQN","Obesity", "daytime_sleepy",            # Outcome & exposure
  "Age_Group", "gender", "race_ethnicity", "income_ratio", "education", "work_schedule","psu", "stratum","interview_weight",  # Model 1
   "physically_active", "energy_kcal", "sat_fat", "sugar", "alcohol_cat", 
  "dyslipidemia", "hypertension", "depression", "diabetes",                        # Model 2
  "apnea_symptoms","snore", "sleep_weekday", "sleep_weekend"  # Model 3
)

analysis_datasnore2 <- complete_cases_all_models2 %>%
  dplyr::select(all_of(analysis_vars))
```


```{r}
covarss <- intersect(colnames(analysis_datasnore2), c("Age_Group", "education", "gender", "race_ethnicity", "income_ratio", "physically_active", "sat_fat", "sugar", "energy_kcal","alcohol_cat", 
  "dyslipidemia", "hypertension", "depression", "diabetes"))
exposure <- "snore"
```



```{r}


#–– 3. Fit a multinomial PS model (with NHANES interview weights) ––#
ps_formula2 <- as.formula(paste(exposure, "~", paste(covarss, collapse = " + ")))

ps_fit2 <- multinom(ps_formula2,
                   data    = analysis_datasnore2,
                   weights = analysis_datasnore2$interview_weight,
                   trace   = FALSE)
```

```{r}
#–– 4. Get fitted probabilities for each level ––#
ps_mat <- predict(ps_fit2, type = "probs")
analysis_datasnore2$p_Never      <- ps_mat[, "Never"]
analysis_datasnore2$p_Occasional <- ps_mat[, "Occasional"]
analysis_datasnore2$p_Frequent   <- ps_mat[, "Frequent"]
```

```{r}
#–– 5. Compute stabilized weights ––#
#  5a. Marginal (unadjusted) probabilities of each snore level
marg_never      <- mean(analysis_datasnore2$snore == "Never")
marg_occasional <- mean(analysis_datasnore2$snore == "Occasional")
marg_frequent   <- mean(analysis_datasnore2$snore == "Frequent")
```



```{r}
#5b. Individual stabilized weight = P(A=a) / p_i(a | X)
analysis_datasnore2$sweight_raww <- with(analysis_datasnore2,
  ifelse(snore == "Never",      marg_never  / p_Never,
  ifelse(snore == "Occasional", marg_occasional / p_Occasional,
                                        marg_frequent   / p_Frequent))
)
```


```{r}
#  5c. Truncate at the 1st and 99th percentiles
q01 <- quantile(analysis_datasnore2$sweight_raww, 0.01)
q99 <- quantile(analysis_datasnore2$sweight_raww, 0.99)
analysis_datasnore2$sweight_trimm <- pmin(pmax(analysis_datasnore2$sweight_raww, q01), q99)
```

```{r}
#–– 6. Plot the PS distributions by actual snore level ––#
#    (using the PS of the received treatment)
analysis_datasnore2$ps_assignedd <- with(analysis_datasnore2,
  ifelse(snore == "Never",      p_Never,
  ifelse(snore == "Occasional", p_Occasional, p_Frequent))
)
ps_plot2 <- ggdensity(
  analysis_datasnore2,
  x      = "ps_assignedd",
  fill   = "snore",
  palette= c("#66c2a5", "#fc8d62", "#8da0cb")
) +
  labs(
    x    = "Propensity Score for Observed Snore Level",
    fill = "Snore"
  ) +
  theme_classic() +
  theme(
    legend.position        = c(.85, .85),
    legend.background      = element_rect(color="grey", fill="white"),
    axis.title             = element_text(size=14),
    axis.text              = element_text(size=12),
    legend.title           = element_text(size=12),
    legend.text            = element_text(size=11)
  )
ps_plot2
```



```{r}
library(tableone)


cov22 <- c("Age_Group", "education", "gender", "race_ethnicity", "income_ratio", "physically_active", "sat_fat", "sugar", "energy_kcal","alcohol_cat", 
  "dyslipidemia", "hypertension", "depression", "diabetes")

design.stab <- svydesign(ids = ~SEQN, weights = ~sweight_trimm, data = analysis_datasnore2)


# Create table ensuring proper data type handling
tab.stab3 <- svyCreateTableOne(
  vars = cov22,
  strata = "snore",
  data = design.stab,
  test = FALSE
)


print(tab.stab3, smd = TRUE)
```

```{r}
bal2 <- bal.tab(snore ~ gender + race_ethnicity + education + income_ratio + Age_Group + physically_active + sat_fat + sugar + energy_kcal + alcohol_cat + dyslipidemia + hypertension + depression + diabetes,
               data = analysis_datasnore2,
               weights = analysis_datasnore2$sweight_trimm,
               method = "weighting",
               s.d.denom = "pooled",
               un = TRUE)

```

```{r}
bal2$Balance


```



```{r}
#formula2 <- snore ~ gender + race_ethnicity + education + income_ratio + Age_Group + physically_active + sat_fat + sugar #+ energy_kcal + alcohol_cat + dyslipidemia + hypertension + depression + diabetes

p2 <- love.plot(bal2,
               weights = analysis_datasnore2$sweight_trimm,
               data = analysis_datasnore2,
               method = "weighting",
               thresholds = c(m = 0.2),
               abs = FALSE,
               shapes = c("circle filled", "triangle filled"),
               colors = c("orange", "green"),
               e.names = c("Original", "Weighted (IPW)"),
               size = 7,
               binary = "std",
               continuous = "std",
               s.d.denom = "pooled",
               var.names = label)
p2
```
Note: The table reports the maximum absolute SMD per covariate level (e.g., gender_Male). The love plot displays the maximum across all pairwise group comparisons for each dummy variable.


```{r}
#–– 9. Create the NHANES survey design with final weights ––#
analysis_datasnore2$final_wtt <- analysis_datasnore2$interview_weight * analysis_datasnore2$sweight_trimm

nhanes_design2 <- svydesign(
  id      = ~psu,
  strata  = ~stratum,
  weights = ~final_wtt,
  data    = analysis_datasnore2,
  nest    = TRUE
)
```


```{r}
#––10. Fit Modified Poisson to estimate Prevalence Ratios ––#
mpr_formula2 <- as.formula(
  "I(Obesity == 'Obese') ~ snore + gender + race_ethnicity + education + income_ratio + Age_Group + physically_active + sat_fat + sugar + energy_kcal + alcohol_cat + dyslipidemia + hypertension + depression + diabetes"
)
mpr_model2 <- svyglm(
  mpr_formula2,
  design = nhanes_design2,
  family = poisson(link = "log")
)

corrected_summary <- summary(mpr_model2, df.resid = degf(nhanes_design2))

coefs <- coef(corrected_summary)
ses <- sqrt(diag(vcov(mpr_model2)))  # std errors
pvals <- coef(summary(mpr_model2, df.resid = degf(nhanes_design2)))[, 4]  # corrected p-values


results_df <- as.data.frame(coefs)
results_df$RR <- exp(results_df$Estimate)
results_df$CI_lower <- exp(results_df$Estimate - 1.96 * ses)
results_df$CI_upper <- exp(results_df$Estimate + 1.96 * ses)
results_df$p_value <- format.pval(pvals, digits = 3, eps = 0.001)


results_df <- results_df[, c("RR", "CI_lower", "CI_upper", "p_value")]
results_df$Variable <- rownames(coefs)
rownames(results_df) <- NULL

results_df <- results_df[, c("Variable", "RR", "CI_lower", "CI_upper", "p_value")]


print(results_df)

```



#### mODEL 3


```{r}
analysis_vars <- c(
  "SEQN","Obesity", "daytime_sleepy",            # Outcome & exposure
  "Age_Group", "gender", "race_ethnicity", "income_ratio", "education", "work_schedule","psu", "stratum","interview_weight",  # Model 1
   "physically_active", "energy_kcal", "sat_fat", "sugar", "alcohol_cat", 
  "dyslipidemia", "hypertension", "depression", "diabetes",                        # Model 2
  "apnea_symptoms","snore", "sleep_weekday", "sleep_weekend"  # Model 3
)

analysis_datasnore3 <- complete_cases_all_models2 %>%
  dplyr::select(all_of(analysis_vars))
```


```{r}
covarsss <- intersect(colnames(analysis_datasnore3), c("Age_Group", "education", "gender", "race_ethnicity", "income_ratio", "physically_active", "sat_fat", "sugar", "energy_kcal","alcohol_cat", 
  "dyslipidemia", "hypertension", "depression", "diabetes", "apnea_symptoms","sleep_weekday", "sleep_weekend", "daytime_sleepy", "work_schedule"))
exposure <- "snore"
```



```{r}
library(nnet)

#–– 3. Fit a multinomial PS model (with NHANES interview weights) ––#
ps_formula3 <- as.formula(paste(exposure, "~", paste(covarsss, collapse = " + ")))

ps_fit3 <- multinom(ps_formula3,
                   data    = analysis_datasnore3,
                   weights = analysis_datasnore3$interview_weight,
                   trace   = FALSE)
```

```{r}
#–– 4. Get fitted probabilities for each level ––#
ps_mat <- predict(ps_fit3, type = "probs")
analysis_datasnore3$p_Never      <- ps_mat[, "Never"]
analysis_datasnore3$p_Occasional <- ps_mat[, "Occasional"]
analysis_datasnore3$p_Frequent   <- ps_mat[, "Frequent"]
```

```{r}
#–– 5. Compute stabilized weights ––#
#  5a. Marginal (unadjusted) probabilities of each snore level
marg_never      <- mean(analysis_datasnore3$snore == "Never")
marg_occasional <- mean(analysis_datasnore3$snore == "Occasional")
marg_frequent   <- mean(analysis_datasnore3$snore == "Frequent")
```



```{r}
#5b. Individual stabilized weight = P(A=a) / p_i(a | X)
analysis_datasnore3$sweight_rawww <- with(analysis_datasnore3,
  ifelse(snore == "Never",      marg_never  / p_Never,
  ifelse(snore == "Occasional", marg_occasional / p_Occasional,
                                        marg_frequent   / p_Frequent))
)
```


```{r}
#  5c. Truncate at the 1st and 99th percentiles
q01 <- quantile(analysis_datasnore3$sweight_rawww, 0.01)
q99 <- quantile(analysis_datasnore3$sweight_rawww, 0.99)
analysis_datasnore3$sweight_trimmm <- pmin(pmax(analysis_datasnore3$sweight_rawww, q01), q99)
```

```{r}
#–– 6. Plot the PS distributions by actual snore level ––#
#    (using the PS of the received treatment)
analysis_datasnore3$ps_assigneddd <- with(analysis_datasnore3,
  ifelse(snore == "Never",      p_Never,
  ifelse(snore == "Occasional", p_Occasional, p_Frequent))
)
ps_plot3 <- ggdensity(
  analysis_datasnore3,
  x      = "ps_assigneddd",
  fill   = "snore",
  palette= c("#66c2a5", "#fc8d62", "#8da0cb")
) +
  labs(
    x    = "Propensity Score for Observed Snore Level",
    fill = "Snore"
  ) +
  theme_classic() +
  theme(
    legend.position        = c(.85, .85),
    legend.background      = element_rect(color="grey", fill="white"),
    axis.title             = element_text(size=14),
    axis.text              = element_text(size=12),
    legend.title           = element_text(size=12),
    legend.text            = element_text(size=11)
  )
ps_plot3
```



```{r}
library(tableone)


cov222 <- c("Age_Group", "education", "gender", "race_ethnicity", "income_ratio", "physically_active", "sat_fat", "sugar", "energy_kcal","alcohol_cat", 
  "dyslipidemia", "hypertension", "depression", "diabetes",  "apnea_symptoms","sleep_weekday", "sleep_weekend", "daytime_sleepy", "work_schedule")

design.stab3 <- svydesign(ids = ~SEQN, weights = ~sweight_trimmm, data = analysis_datasnore3)


# Create table ensuring proper data type handling
tab.stab4 <- svyCreateTableOne(
  vars = cov222,
  strata = "snore",
  data = design.stab3,
  test = FALSE
)


print(tab.stab4, smd = TRUE)
```

```{r}
bal3 <- bal.tab(snore ~ gender + race_ethnicity + education + income_ratio + Age_Group + physically_active + sat_fat + sugar + energy_kcal + alcohol_cat + dyslipidemia + hypertension + depression + diabetes + apnea_symptoms + sleep_weekday + sleep_weekend + daytime_sleepy + work_schedule,
               data = analysis_datasnore3,
               weights = analysis_datasnore3$sweight_trimmm,
               method = "weighting",
               s.d.denom = "pooled",
               un = TRUE)

```

```{r}
bal3$Balance


```



```{r}
#formula3 <- snore ~ gender + race_ethnicity + education + income_ratio + Age_Group + physically_active + sat_fat + sugar #+ energy_kcal + alcohol_cat + dyslipidemia + hypertension + depression + diabetes  + apnea_symptoms + sleep_weekday + #sleep_weekend + daytime_sleepy

p3 <- love.plot(bal3,
               weights = analysis_datasnore3$sweight_trimmm,
               data = analysis_datasnore3,
               method = "weighting",
               thresholds = c(m = 0.2),
               abs = FALSE,
               shapes = c("circle filled", "triangle filled"),
               colors = c("orange", "green"),
               e.names = c("Original", "Weighted (IPW)"),
               size = 7,
               binary = "std",
               continuous = "std",
               s.d.denom = "pooled",
               var.names = label)
p3
```
Note: The table reports the maximum absolute SMD per covariate level (e.g., gender_Male). The love plot displays the maximum across all pairwise group comparisons for each dummy variable.


```{r}
#–– 9. Create the NHANES survey design with final weights ––#
analysis_datasnore3$final_wttt <- analysis_datasnore3$interview_weight * analysis_datasnore3$sweight_trimmm

nhanes_design3 <- svydesign(
  id      = ~psu,
  strata  = ~stratum,
  weights = ~final_wttt,
  data    = analysis_datasnore3,
  nest    = TRUE
)
```


```{r}
#––10. Fit Modified Poisson to estimate Prevalence Ratios ––#
mpr_formula3 <- as.formula(
  "I(Obesity == 'Obese') ~ snore + gender + race_ethnicity + education + income_ratio + Age_Group + physically_active + sat_fat + sugar + energy_kcal + alcohol_cat + dyslipidemia + hypertension + depression + diabetes  + apnea_symptoms + sleep_weekday + sleep_weekend + daytime_sleepy + work_schedule"
)
mpr_model3 <- svyglm(
  mpr_formula3,
  design = nhanes_design3,
  family = poisson(link = "log")
)

corrected_summary2 <- summary(mpr_model3, df.resid = degf(nhanes_design3))

coefs <- coef(corrected_summary2)
ses <- sqrt(diag(vcov(mpr_model3)))  # std errors
pvals <- coef(summary(mpr_model3, df.resid = degf(nhanes_design3)))[, 4]  # corrected p-values


results_df <- as.data.frame(coefs)
results_df$RR <- exp(results_df$Estimate)
results_df$CI_lower <- exp(results_df$Estimate - 1.96 * ses)
results_df$CI_upper <- exp(results_df$Estimate + 1.96 * ses)
results_df$p_value <- format.pval(pvals, digits = 3, eps = 0.001)


results_df <- results_df[, c("RR", "CI_lower", "CI_upper", "p_value")]
results_df$Variable <- rownames(coefs)
rownames(results_df) <- NULL

results_df <- results_df[, c("Variable", "RR", "CI_lower", "CI_upper", "p_value")]


print(results_df)

```






# MICE Imputation

```{r}
mice_nhanes <- data_nhanes[,-c(4,17)]

```






```{r}
library(tableone)

# Drop PSU, Stratum, and SEQN
data_subset <- mice_nhanes[ , !(names(mice_nhanes) %in% c("psu", "stratum", "SEQN","interview_weight", "Exposure"))]


sum_table2 <- table1(~ . | snore, data = data_subset)

sum_table2

```






\footnotesize
\item[1] Values are presented as \textit{n} (\%) for categorical variables and median (Q1, Q3) for continuous variables.
\item[] Missing values for each variable are shown as raw counts.
\item[] This table is based on the analytic sample prior to imputation. A complete-case sample, defined as participants with no missing values on model variables, was used in sensitivity analyses.
\end{TableNotes}

```{r}
library(gtsummary)
library(dplyr)


all_vars <- c(
  "snore", "gender", "race_ethnicity", "income_ratio", 
  "education", "sleep_weekday", "sleep_weekend", "apnea_symptoms", 
  "diabetes", "sat_fat", "sugar", "energy_kcal", "depression", 
  "work_schedule", "hypertension", "Obesity", "Age_Group", "alcohol_cat", 
  "dyslipidemia", "physically_active", "daytime_sleepy"
)

# categorical
cat_vars <- c(
  "snore", "gender", "race_ethnicity", "education", 
  "apnea_symptoms", "diabetes", "depression", 
  "work_schedule", "hypertension", "Obesity", "Age_Group", "alcohol_cat", 
  "dyslipidemia", "physically_active", "daytime_sleepy"
)



# Recode as character FIRST, then convert to factor with correct levels
mice_nhanes <- mice_nhanes %>%
  mutate(
    dyslipidemia = factor(as.character(dyslipidemia), levels = c("No", "Yes")),
    hypertension = factor(as.character(hypertension), levels = c("No", "Yes")),
    physically_active = factor(as.character(physically_active), levels = c("No", "Yes"))
    #Exposure = factor(as.character(Exposure), levels = c("No", "Yes"))
  )


# Create the summary table
table_nhanes2 <- mice_nhanes %>%
  dplyr::select(all_of(all_vars)) %>%
  tbl_summary(
    by = snore,
    type = list(
    all_continuous() ~ "continuous",
    all_categorical() ~ "categorical"),
    missing = "ifany",
    missing_text = "(Missing)",
    statistic = list(
      all_continuous() ~ "{median} ({p25}, {p75})",
      all_categorical() ~ "{n} ({p}%)"
    ),
    digits = all_continuous() ~ 2
  ) %>%
  add_overall() %>%
  bold_labels()


print(table_nhanes2)

```


```{r}

library(howManyImputations)


ini_imp <- mice(mice_nhanes, m = 20, maxit = 5, printFlag = FALSE, seed = 500)


pilot_mod <- with(
  data = ini_imp,
  glm(I(Obesity == "Obese") ~ snore + gender + race_ethnicity +
        Age_Group + education + income_ratio + bmi + 
        work_schedule + physically_active + sat_fat + sugar + energy_kcal +  alcohol_cat + dyslipidemia + hypertension + depression + diabetes + sleep_weekend + daytime_sleepy,
      family = poisson(link = "log"))
)


m_needed <- how_many_imputations(pilot_mod)
print(m_needed)

```
```{r}
imp_init <- mice(mice_nhanes, maxit = 0, print = FALSE)
pred     <- imp_init$pred
meth     <- imp_init$meth     # a named vector of length ncol(data)


# Zero‐out predictors for these variables
for (v in c("SEQN","psu","stratum","interview_weight")) {
  meth[v] <- ""               # do not impute
  pred[,v] <- pred[v,] <- 0   # do not use as predictor
}

# Continuous with predictive mean matching
for (v in c("sat_fat","sugar","energy_kcal","sleep_weekend","income_ratio")) {
  meth[v] <- "pmm"
}

# Binary logistic
for (v in c("hypertension","diabetes","dyslipidemia","alcohol_cat","physically_active")) {
  meth[v] <- "logreg"
}

# Polytomous logistic
for (v in c("apnea_symptoms","education","daytime_sleepy", "depression")) {
  meth[v] <- "polyreg"
}

imputation <- mice(
  data            = mice_nhanes,
  predictorMatrix = pred,
  method          = meth,
  m               = m_needed,    
  maxit           = 10,
  seed            = 123,
  printFlag       = FALSE
)

```






```{r, include=FALSE}
impdata <- mice::complete(imputation, action = "long")

```






```{r, message=FALSE, include=FALSE}


impdata$.id <- NULL
m <- m_needed
set.seed(123)

allImputations <- imputationList(lapply(1:m, 
                                         function(n)
                                           subset(impdata, subset=.imp==n)))

str(allImputations)

```



```{r}

DataExplorer::plot_missing(impdata)
```



Step 2: PS weighting steps 1-3 by DuGoff et al. (2014)
Our next step is to use steps 1-3 of the PS weighting analysis:

Step 2.1: Fit the PS model by considering survey features as covariates.
Step 2.2: Calculate PS weights
Step 2.3: Balance checking using SMD. Consider SMD <0.2 as a good covariate balancing.
Step 2.1: PS model specification 

# Model 1

```{r}
library(nnet)
library(survey)
library(mice)
library(cobalt)
library(tableone)
library(dplyr)

# Assume imputed long data is already created as `impdata` from mice()

dat.ps <- list(NULL)
m <- m_needed  # number of imputations

for (ii in 1:m) {
  dat.imputed <- subset(impdata, .imp == ii)

  # Multinomial logistic PS model
  ps_formula <- as.formula("snore ~ Age_Group + gender + income_ratio + education + race_ethnicity + psu + stratum + interview_weight")

  ps_fit <- multinom(ps_formula, data = dat.imputed, weights = dat.imputed$interview_weight, trace = FALSE)

  ps_mat <- predict(ps_fit, type = "probs")

  # Attach fitted probabilities
  dat.imputed$p_Never      <- ps_mat[, "Never"]
  dat.imputed$p_Occasional <- ps_mat[, "Occasional"]
  dat.imputed$p_Frequent   <- ps_mat[, "Frequent"]

  # Marginal probabilities
  marg_probs <- prop.table(table(dat.imputed$snore))

  # Stabilized weight
  dat.imputed$sweight <- with(dat.imputed, ifelse(
    snore == "Never", marg_probs["Never"] / p_Never,
    ifelse(snore == "Occasional", marg_probs["Occasional"] / p_Occasional,
           marg_probs["Frequent"] / p_Frequent)
  ))

  # Truncate weights at 1st and 99th percentiles
  q01 <- quantile(dat.imputed$sweight, 0.01)
  q99 <- quantile(dat.imputed$sweight, 0.99)
  dat.imputed$sweight <- pmin(pmax(dat.imputed$sweight, q01), q99)

  dat.ps[[ii]] <- dat.imputed
}

```





# Covariate Balance and SMD

```{r, include=FALSE}
tab1m <- list(NULL)
for (ii in 1:m) {
  dat <- dat.ps[[ii]]

  vars <- c("Age_Group", "gender", "education", "race_ethnicity", "income_ratio")

  design <- svydesign(ids = ~SEQN, weights = ~sweight, data = dat)
  tab1m[[ii]] <- svyCreateTableOne(vars = vars, strata = "snore", data = design, test = FALSE)
}
print(tab1m, smd = TRUE)

```




```{r}
# library(cobalt)
# library(dplyr)
# 
# 
# balance_formula <- Exposure ~ Age_Group + gender + education + race_ethnicity +
#   income_ratio
# 
# # Store the SMDs in a list
# smd_list <- list()
# 
# for (i in 1:m) {
#   dat <- dat.ps[[i]]
#   
#   # Compute balance
#   bal <- bal.tab(
#     x = balance_formula,
#     data = dat,
#     weights = dat$sweight,
#     method = "weighting",
#     estimand = "ATE"
#   )
#   
#   # Extract only the SMDs from the balance table
#   smd_vector <- bal$Balance[, "Diff.Adj"]
#   names(smd_vector) <- rownames(bal$Balance)
#   
#   smd_list[[i]] <- smd_vector
# }
# 
# smd_df <- do.call(rbind, smd_list)  # each row is an imputation
# 
# # Summarize across imputations
# smd_summary <- data.frame(
#   Variable = colnames(smd_df),
#   Mean_SMD = apply(smd_df, 2, mean, na.rm = TRUE),
#   Max_SMD = apply(smd_df, 2, function(x) max(abs(x), na.rm = TRUE))
# )
# 
# 
# print(smd_summary)
# 

```



```{r}
# Combine all imputations
dat_combined <- bind_rows(dat.ps, .id = ".imp")
dat_combined$.imp <- as.integer(dat_combined$.imp)

balance_formula <- snore ~ Age_Group + gender + education + race_ethnicity + income_ratio

bal2 <- bal.tab(
  balance_formula,
  data = dat_combined,
  weights = dat_combined$sweight,
  imp = ".imp",
  method = "weighting",
  estimand = "ATE",
  s.d.denom = "pooled",
  m.threshold = 0.2,
  un = TRUE
)

var.labels <- c(
  Age_Group = "Age Group",
  gender = "Gender",
  education = "Education",
  income_ratio = "Income Ratio",
  race_ethnicity = "Race/Ethnicity"
)

pp <- love.plot(
  x = bal2,
  stat = "mean.diffs",
  abs = FALSE,
  thresholds = c(m = 0.2),
  var.names = var.labels,
  binary = "std",
  continuous = "std",
  shapes = c("circle filled", "triangle filled"),
  colors = c("orange", "darkgreen"),
  e.names = c("Unweighted", "Weighted (IPTW)"),
  size = 7,
  disp = "dots"
)

pp

```







```{r}

# Create new combined weights
for (ii in 1:m) {
  dat <- dat.ps[[ii]]
  dat$new_weight <- with(dat, interview_weight * sweight)
  dat.ps[[ii]] <- dat
}

# Create survey design per imputation
survey_designs <- lapply(dat.ps, function(dat) {
  svydesign(
    ids = ~psu,
    strata = ~stratum,
    weights = ~new_weight,
    data = dat,
    nest = TRUE
  )
})

# Model formula
mpr_formula <- as.formula("I(Obesity == 'Obese') ~ snore + gender + race_ethnicity + education + income_ratio + Age_Group")

# Fit model on each design
fit_list <- lapply(survey_designs, function(des) {
  svyglm(mpr_formula, design = des, family = poisson(link = "log"))
})

# Pool results
pooled <- MIcombine(fit_list)
PR <- round(exp(pooled$coefficients), 2)
CI <- round(exp(confint(pooled)), 2)
result <- data.frame(Estimate = PR, CI_lower = CI[,1], CI_upper = CI[,2])
print(result)

```



# model 2


```{r}
model2.ps_list <- list(NULL)
for (i in 1:m_needed) {
  dat <- subset(impdata, .imp == i)

  # Full covariate list (Model 1 + extras)
  covariates_model2 <- c("Age_Group", "gender", "income_ratio", "education", "race_ethnicity",
                         "psu", "stratum", "interview_weight",
                         "physically_active", "sat_fat", "energy_kcal", "sugar",
                         "alcohol_cat", "dyslipidemia", "hypertension", "depression", "diabetes")

  ps_formula_m2 <- as.formula(paste("snore ~", paste(covariates_model2, collapse = " + ")))

  ps_fit_m2 <- multinom(ps_formula_m2, data = dat, weights = dat$interview_weight, trace = FALSE)
  ps_mat_m2 <- predict(ps_fit_m2, type = "probs")

  dat$p_Never <- ps_mat_m2[, "Never"]
  dat$p_Occasional <- ps_mat_m2[, "Occasional"]
  dat$p_Frequent <- ps_mat_m2[, "Frequent"]

  marg_probs <- prop.table(table(dat$snore))

  dat$sweight_m2 <- with(dat, ifelse(
    snore == "Never", marg_probs["Never"] / p_Never,
    ifelse(snore == "Occasional", marg_probs["Occasional"] / p_Occasional,
           marg_probs["Frequent"] / p_Frequent)
  ))

  # Truncate
  q01 <- quantile(dat$sweight_m2, 0.01)
  q99 <- quantile(dat$sweight_m2, 0.99)
  dat$sweight_m2 <- pmin(pmax(dat$sweight_m2, q01), q99)

  model2.ps_list[[i]] <- dat
}

```



```{r}
# Combine for pooled SMD
model2_combined <- bind_rows(model2.ps_list, .id = ".imp")
model2_combined$.imp <- as.integer(model2_combined$.imp)

balance_formula_m2 <- snore ~ Age_Group + gender + income_ratio + education + race_ethnicity +
  physically_active + sat_fat + energy_kcal + sugar + alcohol_cat +
  dyslipidemia + hypertension + depression + diabetes

bal_model2 <- bal.tab(
  balance_formula_m2,
  data = model2_combined,
  weights = model2_combined$sweight_m2,
  imp = ".imp",
  method = "weighting",
  s.d.denom = "pooled",
  m.threshold = 0.2,
  un = TRUE
)

# Labels for plot
labels_model2 <- c(
  Age_Group = "Age Group",
  gender = "Gender",
  education = "Education",
  income_ratio = "Income Ratio",
  race_ethnicity = "Race/Ethnicity",
  physically_active = "Physical Activity",
  sat_fat = "Saturated Fat",
  energy_kcal = "Energy Intake (kcal)",
  sugar = "Sugar",
  alcohol_cat = "Alcohol Category",
  dyslipidemia = "Dyslipidemia",
  hypertension = "Hypertension",
  depression = "Depression",
  diabetes = "Diabetes"
)

# Love plot
love_model2 <- love.plot(
  x = bal_model2,
  stat = "mean.diffs",
  abs = FALSE,
  thresholds = c(m = 0.2),
  var.names = labels_model2,
  binary = "std",
  continuous = "std",
  shapes = c("circle filled", "triangle filled"),
  colors = c("orange", "darkgreen"),
  e.names = c("Unweighted", "Weighted (IPTW)"),
  size = 7,
  disp = "dots"
)

love_model2

```


```{r}
# Combine weights
for (i in 1:m_needed) {
  dat <- model2.ps_list[[i]]
  dat$new_weight_m2 <- with(dat, interview_weight * sweight_m2)
  model2.ps_list[[i]] <- dat
}

# Create survey designs
survey_designs_m2 <- lapply(model2.ps_list, function(dat) {
  svydesign(
    ids = ~psu,
    strata = ~stratum,
    weights = ~new_weight_m2,
    data = dat,
    nest = TRUE
  )
})

# Outcome model with same covariates (Model 2)
mpr_formula_m2 <- as.formula(
  "I(Obesity == 'Obese') ~ snore + gender + race_ethnicity + education +
   income_ratio + Age_Group + physically_active + sat_fat + energy_kcal +
   sugar + alcohol_cat + dyslipidemia + hypertension + depression + diabetes"
)

fit_list_m2 <- lapply(survey_designs_m2, function(des) {
  svyglm(mpr_formula_m2, design = des, family = poisson(link = "log"))
})

# Pool PRs
pooled_m2 <- MIcombine(fit_list_m2)
PR_m2 <- round(exp(pooled_m2$coefficients), 2)
CI_m2 <- round(exp(confint(pooled_m2)), 2)
result_model2 <- data.frame(
  Estimate = PR_m2,
  CI_lower = CI_m2[, 1],
  CI_upper = CI_m2[, 2]
)
print(result_model2)

```



## model 3

```{r}
covariates_model3 <- c(
  # Model 1
  "Age_Group", "gender", "income_ratio", "education", "race_ethnicity",
  # Model 2
  "physically_active", "sat_fat", "energy_kcal", "sugar", "alcohol_cat",
  "dyslipidemia", "hypertension", "depression", "diabetes",
  # Model 3
  "sleep_weekday", "sleep_weekend", "daytime_sleepy", "apnea_symptoms", "work_schedule",
  # Survey structure
  "psu", "stratum", "interview_weight"
)

```


```{r}
model3.ps_list <- list(NULL)
for (i in 1:m_needed) {
  dat <- subset(impdata, .imp == i)

  ps_formula_m3 <- as.formula(paste("snore ~", paste(covariates_model3, collapse = " + ")))

  ps_fit_m3 <- multinom(ps_formula_m3, data = dat, weights = dat$interview_weight, trace = FALSE)
  ps_mat_m3 <- predict(ps_fit_m3, type = "probs")

  dat$p_Never      <- ps_mat_m3[, "Never"]
  dat$p_Occasional <- ps_mat_m3[, "Occasional"]
  dat$p_Frequent   <- ps_mat_m3[, "Frequent"]

  marg_probs <- prop.table(table(dat$snore))

  dat$sweight_m3 <- with(dat, ifelse(
    snore == "Never",      marg_probs["Never"] / p_Never,
    ifelse(snore == "Occasional", marg_probs["Occasional"] / p_Occasional,
           marg_probs["Frequent"]   / p_Frequent)
  ))

  q01 <- quantile(dat$sweight_m3, 0.01)
  q99 <- quantile(dat$sweight_m3, 0.99)
  dat$sweight_m3 <- pmin(pmax(dat$sweight_m3, q01), q99)

  model3.ps_list[[i]] <- dat
}

```


```{r}
model3_combined <- bind_rows(model3.ps_list, .id = ".imp")
model3_combined$.imp <- as.integer(model3_combined$.imp)

balance_formula_m3 <- snore ~ Age_Group + gender + income_ratio + education + race_ethnicity +
  physically_active + sat_fat + energy_kcal + sugar + alcohol_cat +
  dyslipidemia + hypertension + depression + diabetes +
  sleep_weekday + sleep_weekend + daytime_sleepy + apnea_symptoms + work_schedule

bal_model3 <- bal.tab(
  x = balance_formula_m3,
  data = model3_combined,
  weights = model3_combined$sweight_m3,
  imp = ".imp",
  method = "weighting",
  s.d.denom = "pooled",
  m.threshold = 0.2,
  un = TRUE
)

# Optional: adjust labels for Love plot
labels_model3 <- c(
  Age_Group = "Age Group",
  gender = "Gender",
  education = "Education",
  income_ratio = "Income Ratio",
  race_ethnicity = "Race/Ethnicity",
  physically_active = "Physical Activity",
  sat_fat = "Saturated Fat",
  energy_kcal = "Energy (kcal)",
  sugar = "Sugar Intake",
  alcohol_cat = "Alcohol Use",
  dyslipidemia = "Dyslipidemia",
  hypertension = "Hypertension",
  depression = "Depression",
  diabetes = "Diabetes",
  sleep_weekday = "Weekday Sleep (hrs)",
  sleep_weekend = "Weekend Sleep (hrs)",
  daytime_sleepy = "Daytime Sleepiness",
  apnea_symptoms = "Apnea Symptoms"
)

love_model3 <- love.plot(
  x = bal_model3,
  stat = "mean.diffs",
  abs = FALSE,
  thresholds = c(m = 0.2),
  var.names = labels_model3,
  binary = "std",
  continuous = "std",
  shapes = c("circle filled", "triangle filled"),
  colors = c("orange", "darkgreen"),
  e.names = c("Unweighted", "Weighted (IPTW)"),
  size = 7,
  disp = "dots"
)

love_model3

```


```{r}
# Combine survey + PS weights
for (i in 1:m_needed) {
  dat <- model3.ps_list[[i]]
  dat$new_weight_m3 <- with(dat, interview_weight * sweight_m3)
  model3.ps_list[[i]] <- dat
}

survey_designs_m3 <- lapply(model3.ps_list, function(dat) {
  svydesign(
    ids = ~psu,
    strata = ~stratum,
    weights = ~new_weight_m3,
    data = dat,
    nest = TRUE
  )
})

mpr_formula_m3 <- as.formula(
  "I(Obesity == 'Obese') ~ snore + gender + race_ethnicity + education +
   income_ratio + Age_Group + physically_active + sat_fat + energy_kcal +
   sugar + alcohol_cat + dyslipidemia + hypertension + depression + diabetes +
   sleep_weekday + sleep_weekend + daytime_sleepy + apnea_symptoms + work_schedule"
)

fit_list_m3 <- lapply(survey_designs_m3, function(des) {
  svyglm(mpr_formula_m3, design = des, family = poisson(link = "log"))
})

pooled_m3 <- MIcombine(fit_list_m3)
PR_m3 <- round(exp(pooled_m3$coefficients), 2)
CI_m3 <- round(exp(confint(pooled_m3)), 2)
result_model3 <- data.frame(
  Estimate = PR_m3,
  CI_lower = CI_m3[, 1],
  CI_upper = CI_m3[, 2]
)
print(result_model3)

```







