---
title: "NHANES PAPER DATA Cleaning"
subtitle: "NHANES 2017-2018"
author: 
  - "Theophilus G. Baidoo^[tbaidoo@iu.edu, Indiana University Bloomington.]"
date: "`r format(Sys.Date(), '%B %d, %Y')`"
output:
  bookdown::pdf_document2:
    fig_caption: true
    latex_engine: xelatex
    number_sections: false
    toc: false
    toc_depth: 4
header-includes:
  - \usepackage{amsmath}
  - \usepackage{amssymb}
  - \usepackage{amsfonts}
  - \usepackage{amsthm}
  - \usepackage{pdfpages}
  - \usepackage{floatrow}
  - \usepackage{fancyhdr}
  - \pagestyle{fancy}
  - \fancyhf{}
  - \rhead{Theophilus Baidoo}
  - \lhead{}
  - \cfoot{\thepage}
  - \usepackage{algorithm}
  - \usepackage[noend]{algpseudocode}
geometry: margin=0.8in
fontsize: 11pt
params:
  proj_number: 
  proj_title: ""
---


```{r}
nhanes_data <- read.csv("merged_dataset.csv", header = TRUE)

head(nhanes_data)
```

```{r}
# Convert SEQN to sequential numbers starting from 1
nhanes_data$SEQN <- seq(1, nrow(nhanes_data))

# Loop through columns and convert character columns to factors
for (col_name in names(nhanes_data)) {
  if (is.character(nhanes_data[[col_name]])) {
    nhanes_data[[col_name]] <- as.factor(nhanes_data[[col_name]])
  }
}

# Print the structure of the updated dataset to verify
str(nhanes_data)


```


```{r}
# Convert "Don't know" and "Refused" to NA for relevant variables, preserving factor levels
columns_to_clean <- c("depression", "trouble_sleep", "diabetes", "education", "snore","apnea_symptoms","daytime_sleepy","work_vigorous","work_moderate","hypertension")

for (col in columns_to_clean) {
  # Ensure column is treated as a factor
  nhanes_data[[col]] <- factor(nhanes_data[[col]])
  
  # Replace "Don't know" and "Refused" with NA
  nhanes_data[[col]] <- forcats::fct_recode(nhanes_data[[col]], NULL = "Don't know", NULL = "Refused", NULL = "Don't Know")
}

# Replace 999 in Alcohol_Consumption with NA, keeping it numeric
# Replace 999 and 777 in Alcohol_Consumption with NA, keeping it numeric
nhanes_data$alcohol_day <- ifelse(nhanes_data$alcohol_day %in% c(999, 777), NA, nhanes_data$alcohol_day)


# Calculate the 99th percentiles
sugar_99 <- quantile(nhanes_data$sugar, 0.99, na.rm = TRUE)
sat_fat_99 <- quantile(nhanes_data$sat_fat, 0.99, na.rm = TRUE)

# Cap only non-NA values above the 99th percentile
nhanes_data$sugar <- ifelse(
  !is.na(nhanes_data$sugar) & nhanes_data$sugar > sugar_99,
  sugar_99,
  nhanes_data$sugar
)

nhanes_data$sat_fat <- ifelse(
  !is.na(nhanes_data$sat_fat) & nhanes_data$sat_fat > sat_fat_99,
  sat_fat_99,
  nhanes_data$sat_fat
)


# Ensure numeric variables retain their type
numeric_columns <- c("alcohol_day", "sugar", "sat_fat", "sleep_weekday", "bmi", "interview_weight", "SEQN")
for (col in numeric_columns) {
  nhanes_data[[col]] <- as.numeric(nhanes_data[[col]])
}


#nhanes_data <- nhanes_data %>%
#  mutate(
 #   work_vigorous_minutes = ifelse(work_vigorous_minutes > #960, NA, work_vigorous_minutes),
#    work_moderate_minutes = ifelse(work_moderate_minutes > #960, NA, work_moderate_minutes),
#    walk_bike_minutes      = ifelse(walk_bike_minutes > 600, #NA, walk_bike_minutes),
#    leisure_vigorous_minutes = #ifelse(leisure_vigorous_minutes > 600, NA, #leisure_vigorous_minutes),
#    leisure_moderate_minutes = #ifelse(leisure_moderate_minutes > 600, NA, #leisure_moderate_minutes),
 #   sedentary_minutes = ifelse(sedentary_minutes > 1440, NA, #sedentary_minutes),

    # Cap day values to 7
 #   walk_bike_days = ifelse(walk_bike_days > 7, NA, #walk_bike_days),
#    work_vigorous_days = ifelse(work_vigorous_days > 7, NA, #work_vigorous_days),
#    work_moderate_days = ifelse(work_moderate_days > 7, NA, #work_moderate_days),
 #   leisure_vigorous_days = ifelse(leisure_vigorous_days > #7, NA, leisure_vigorous_days),
#    leisure_moderate_days = ifelse(leisure_moderate_days > #7, NA, leisure_moderate_days)
#  )
```


```{r}
# Check the updated structure of the dataset
summary(nhanes_data)




```
## Data collection and cleaning process

Data for this study were obtained from the National Health and Nutrition Examination Survey (NHANES) for the 2017–2018 cycle. NHANES is a nationally representative, cross-sectional survey conducted by the National Center for Health Statistics (NCHS). It combines interviews, physical examinations, and laboratory tests to assess the health and nutritional status of the civilian, non-institutionalized U.S. population. For this analysis, we focused on adult participants aged 18 years and older.

We merged relevant NHANES datasets using the unique participant identifier (SEQN). Variables were drawn from multiple components, including demographics, dietary intake, physical activity, occupation, sleep health, mental health, medical conditions, and laboratory results. The final dataset included information on age, sex, race/ethnicity, education, income-to-poverty ratio, marital status, and employment characteristics. Sleep variables included weekday and weekend sleep duration, self-reported trouble sleeping, snoring frequency, breathing interruptions during sleep, and daytime sleepiness. Key health outcomes included body mass index (BMI), self-reported diabetes, hypertension, and depression, as well as lipid profiles and dietary intake (total sugar, saturated fat, and total caloric intake).

Physical activity data were obtained from the Physical Activity Questionnaire (PAQ) and included work, transportation, and leisure-time activity. Specifically, we downloaded variables indicating whether the participant engaged in vigorous or moderate work activity (PAQ605, PAQ620), recreational activity (PAQ650, PAQ665), and walking or biking for transportation (PAQ635). To assess duration and frequency, we also included corresponding variables for number of days per week (PAQ610, PAQ625, PAQ640, PAQ655, PAQ670) and minutes per day (PAD615, PAD630, PAD645, PAD660, PAD675). Sedentary behavior was assessed using PAD680, which records minutes spent sitting or reclining per day.

To ensure valid estimates, we reviewed physical activity variables for outliers and implausible values. Reported values exceeding humanly possible durations—such as over 960 minutes (16 hours) per day or more than 7 days per week—were set to missing. For example, work_vigorous_minutes, walk_bike_minutes, and other *_minutes fields were capped at a maximum of 600 to 960 minutes per day, and all *_days variables were capped at 7. These thresholds align with established physical activity data cleaning practices to avoid skewing total activity estimates.

Data cleaning involved additional steps to ensure consistency and accuracy. Variables with coded responses such as "Refused" or "Don't know" were recoded as missing to avoid misclassification. Categorical variables were converted to factors with meaningful labels reflecting NHANES documentation. For dietary and alcohol intake variables, extreme values such as 999 or 777, which indicate missing or unreliable responses, were set to NA. Implausible values for continuous variables, such as total sugar intake greater than 500 grams or saturated fat intake above 100 grams per day, were also treated as missing.

Numeric variables were explicitly converted to ensure proper format for statistical analysis. The dataset was then checked for missingness and consistency using summary statistics. All variables were reviewed to confirm that values fell within expected ranges based on NHANES documentation. The final cleaned dataset was prepared for analysis with survey weights, stratification, and clustering accounted for using NHANES sampling design variables.

## Also this
The data cleaning process began with a careful review of the dataset's structure and summary statistics to identify inconsistencies, irrelevant categories, and nonsensical values that could impact analysis. The primary goal was to ensure all variables were properly formatted, missing values were appropriately handled, and placeholder or extreme values were addressed to create a clean and reliable dataset.

First, the SEQN variable, which initially contained numeric identifiers, was restructured into sequential numbers starting from 1. This change was made to simplify indexing and eliminate any ambiguity regarding its purpose in the dataset. Next, all character variables were converted to factors to ensure categorical data was stored appropriately, which is crucial for downstream statistical analyses and modeling.

The dataset contained various placeholders and irrelevant responses, such as "Don't know" and "Refused," which were identified as non-informative categories. These were systematically replaced with NA in variables such as Depression_Score, Trouble_Sleeping, Diabetes_Status, and Physical_Activity. This step allowed for a more accurate representation of missing or unknown data.

For numerical variables, specific attention was given to unrealistic or placeholder values. For instance, in the Alcohol_Consumption variable, a maximum value of 999 was clearly a placeholder and was replaced with NA. Similarly, extreme outliers in sugar and sat_fat were addressed by capping the values to reasonable thresholds, with entries exceeding 500 grams for sugar and 100 grams for saturated fat flagged as NA.

Throughout the process, the structure and summary of the dataset were frequently examined to validate changes and ensure that no unintended modifications occurred. This systematic approach ensured that the dataset was clean, consistent, and ready for further analysis, free from issues that could compromise the integrity of the results. The cleaning decisions were guided by both statistical reasoning and domain knowledge to maintain the relevance and quality of the data.

```{r}
# Save the dataset as an RDS file to preserve data types
saveRDS(nhanes_data, file = "nhanes_cleandata.rds")

```

